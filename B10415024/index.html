<html xmlns:v="urn:schemas-microsoft-com:vml"
xmlns:o="urn:schemas-microsoft-com:office:office"
xmlns:w="urn:schemas-microsoft-com:office:word"
xmlns:m="http://schemas.microsoft.com/office/2004/12/omml"
xmlns="http://www.w3.org/TR/REC-html40">

<head>
<meta http-equiv=Content-Type content="text/html; charset=big5">
<meta name=ProgId content=Word.Document>
<meta name=Generator content="Microsoft Word 14">
<meta name=Originator content="Microsoft Word 14">
<link rel=File-List href="index.files/filelist.xml">
<!--[if gte mso 9]><xml>
 <o:DocumentProperties>
  <o:Author>藍藍</o:Author>
  <o:LastAuthor>藍藍</o:LastAuthor>
  <o:Revision>2</o:Revision>
  <o:TotalTime>818</o:TotalTime>
  <o:Created>2017-10-15T05:23:00Z</o:Created>
  <o:LastSaved>2017-10-15T05:23:00Z</o:LastSaved>
  <o:Pages>17</o:Pages>
  <o:Words>2926</o:Words>
  <o:Characters>16679</o:Characters>
  <o:Lines>138</o:Lines>
  <o:Paragraphs>39</o:Paragraphs>
  <o:CharactersWithSpaces>19566</o:CharactersWithSpaces>
  <o:Version>14.00</o:Version>
 </o:DocumentProperties>
 <o:OfficeDocumentSettings>
  <o:RelyOnVML/>
  <o:AllowPNG/>
 </o:OfficeDocumentSettings>
</xml><![endif]-->
<link rel=themeData href="index.files/themedata.thmx">
<link rel=colorSchemeMapping href="index.files/colorschememapping.xml">
<!--[if gte mso 9]><xml>
 <w:WordDocument>
  <w:SpellingState>Clean</w:SpellingState>
  <w:GrammarState>Clean</w:GrammarState>
  <w:TrackMoves>false</w:TrackMoves>
  <w:TrackFormatting/>
  <w:PunctuationKerning/>
  <w:DisplayHorizontalDrawingGridEvery>0</w:DisplayHorizontalDrawingGridEvery>
  <w:DisplayVerticalDrawingGridEvery>2</w:DisplayVerticalDrawingGridEvery>
  <w:ValidateAgainstSchemas/>
  <w:SaveIfXMLInvalid>false</w:SaveIfXMLInvalid>
  <w:IgnoreMixedContent>false</w:IgnoreMixedContent>
  <w:AlwaysShowPlaceholderText>false</w:AlwaysShowPlaceholderText>
  <w:DoNotPromoteQF/>
  <w:LidThemeOther>EN-US</w:LidThemeOther>
  <w:LidThemeAsian>ZH-TW</w:LidThemeAsian>
  <w:LidThemeComplexScript>X-NONE</w:LidThemeComplexScript>
  <w:Compatibility>
   <w:SpaceForUL/>
   <w:BalanceSingleByteDoubleByteWidth/>
   <w:DoNotLeaveBackslashAlone/>
   <w:ULTrailSpace/>
   <w:DoNotExpandShiftReturn/>
   <w:AdjustLineHeightInTable/>
   <w:BreakWrappedTables/>
   <w:SnapToGridInCell/>
   <w:WrapTextWithPunct/>
   <w:UseAsianBreakRules/>
   <w:DontGrowAutofit/>
   <w:SplitPgBreakAndParaMark/>
   <w:EnableOpenTypeKerning/>
   <w:DontFlipMirrorIndents/>
   <w:OverrideTableStyleHps/>
   <w:UseFELayout/>
  </w:Compatibility>
  <m:mathPr>
   <m:mathFont m:val="Cambria Math"/>
   <m:brkBin m:val="before"/>
   <m:brkBinSub m:val="&#45;-"/>
   <m:smallFrac m:val="off"/>
   <m:dispDef/>
   <m:lMargin m:val="0"/>
   <m:rMargin m:val="0"/>
   <m:defJc m:val="centerGroup"/>
   <m:wrapIndent m:val="1440"/>
   <m:intLim m:val="subSup"/>
   <m:naryLim m:val="undOvr"/>
  </m:mathPr></w:WordDocument>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <w:LatentStyles DefLockedState="false" DefUnhideWhenUsed="true"
  DefSemiHidden="true" DefQFormat="false" DefPriority="99"
  LatentStyleCount="267">
  <w:LsdException Locked="false" Priority="0" SemiHidden="false"
   UnhideWhenUsed="false" QFormat="true" Name="Normal"/>
  <w:LsdException Locked="false" Priority="9" SemiHidden="false"
   UnhideWhenUsed="false" QFormat="true" Name="heading 1"/>
  <w:LsdException Locked="false" Priority="9" QFormat="true" Name="heading 2"/>
  <w:LsdException Locked="false" Priority="9" QFormat="true" Name="heading 3"/>
  <w:LsdException Locked="false" Priority="9" QFormat="true" Name="heading 4"/>
  <w:LsdException Locked="false" Priority="9" QFormat="true" Name="heading 5"/>
  <w:LsdException Locked="false" Priority="9" QFormat="true" Name="heading 6"/>
  <w:LsdException Locked="false" Priority="9" QFormat="true" Name="heading 7"/>
  <w:LsdException Locked="false" Priority="9" QFormat="true" Name="heading 8"/>
  <w:LsdException Locked="false" Priority="9" QFormat="true" Name="heading 9"/>
  <w:LsdException Locked="false" Priority="39" Name="toc 1"/>
  <w:LsdException Locked="false" Priority="39" Name="toc 2"/>
  <w:LsdException Locked="false" Priority="39" Name="toc 3"/>
  <w:LsdException Locked="false" Priority="39" Name="toc 4"/>
  <w:LsdException Locked="false" Priority="39" Name="toc 5"/>
  <w:LsdException Locked="false" Priority="39" Name="toc 6"/>
  <w:LsdException Locked="false" Priority="39" Name="toc 7"/>
  <w:LsdException Locked="false" Priority="39" Name="toc 8"/>
  <w:LsdException Locked="false" Priority="39" Name="toc 9"/>
  <w:LsdException Locked="false" Priority="35" QFormat="true" Name="caption"/>
  <w:LsdException Locked="false" Priority="10" SemiHidden="false"
   UnhideWhenUsed="false" QFormat="true" Name="Title"/>
  <w:LsdException Locked="false" Priority="1" Name="Default Paragraph Font"/>
  <w:LsdException Locked="false" Priority="11" SemiHidden="false"
   UnhideWhenUsed="false" QFormat="true" Name="Subtitle"/>
  <w:LsdException Locked="false" Priority="22" SemiHidden="false"
   UnhideWhenUsed="false" QFormat="true" Name="Strong"/>
  <w:LsdException Locked="false" Priority="20" SemiHidden="false"
   UnhideWhenUsed="false" QFormat="true" Name="Emphasis"/>
  <w:LsdException Locked="false" Priority="59" SemiHidden="false"
   UnhideWhenUsed="false" Name="Table Grid"/>
  <w:LsdException Locked="false" UnhideWhenUsed="false" Name="Placeholder Text"/>
  <w:LsdException Locked="false" Priority="1" SemiHidden="false"
   UnhideWhenUsed="false" QFormat="true" Name="No Spacing"/>
  <w:LsdException Locked="false" Priority="60" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light Shading"/>
  <w:LsdException Locked="false" Priority="61" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light List"/>
  <w:LsdException Locked="false" Priority="62" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light Grid"/>
  <w:LsdException Locked="false" Priority="63" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Shading 1"/>
  <w:LsdException Locked="false" Priority="64" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Shading 2"/>
  <w:LsdException Locked="false" Priority="65" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium List 1"/>
  <w:LsdException Locked="false" Priority="66" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium List 2"/>
  <w:LsdException Locked="false" Priority="67" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 1"/>
  <w:LsdException Locked="false" Priority="68" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 2"/>
  <w:LsdException Locked="false" Priority="69" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 3"/>
  <w:LsdException Locked="false" Priority="70" SemiHidden="false"
   UnhideWhenUsed="false" Name="Dark List"/>
  <w:LsdException Locked="false" Priority="71" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful Shading"/>
  <w:LsdException Locked="false" Priority="72" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful List"/>
  <w:LsdException Locked="false" Priority="73" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful Grid"/>
  <w:LsdException Locked="false" Priority="60" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light Shading Accent 1"/>
  <w:LsdException Locked="false" Priority="61" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light List Accent 1"/>
  <w:LsdException Locked="false" Priority="62" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light Grid Accent 1"/>
  <w:LsdException Locked="false" Priority="63" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Shading 1 Accent 1"/>
  <w:LsdException Locked="false" Priority="64" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Shading 2 Accent 1"/>
  <w:LsdException Locked="false" Priority="65" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium List 1 Accent 1"/>
  <w:LsdException Locked="false" UnhideWhenUsed="false" Name="Revision"/>
  <w:LsdException Locked="false" Priority="34" SemiHidden="false"
   UnhideWhenUsed="false" QFormat="true" Name="List Paragraph"/>
  <w:LsdException Locked="false" Priority="29" SemiHidden="false"
   UnhideWhenUsed="false" QFormat="true" Name="Quote"/>
  <w:LsdException Locked="false" Priority="30" SemiHidden="false"
   UnhideWhenUsed="false" QFormat="true" Name="Intense Quote"/>
  <w:LsdException Locked="false" Priority="66" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium List 2 Accent 1"/>
  <w:LsdException Locked="false" Priority="67" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 1 Accent 1"/>
  <w:LsdException Locked="false" Priority="68" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 2 Accent 1"/>
  <w:LsdException Locked="false" Priority="69" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 3 Accent 1"/>
  <w:LsdException Locked="false" Priority="70" SemiHidden="false"
   UnhideWhenUsed="false" Name="Dark List Accent 1"/>
  <w:LsdException Locked="false" Priority="71" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful Shading Accent 1"/>
  <w:LsdException Locked="false" Priority="72" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful List Accent 1"/>
  <w:LsdException Locked="false" Priority="73" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful Grid Accent 1"/>
  <w:LsdException Locked="false" Priority="60" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light Shading Accent 2"/>
  <w:LsdException Locked="false" Priority="61" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light List Accent 2"/>
  <w:LsdException Locked="false" Priority="62" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light Grid Accent 2"/>
  <w:LsdException Locked="false" Priority="63" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Shading 1 Accent 2"/>
  <w:LsdException Locked="false" Priority="64" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Shading 2 Accent 2"/>
  <w:LsdException Locked="false" Priority="65" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium List 1 Accent 2"/>
  <w:LsdException Locked="false" Priority="66" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium List 2 Accent 2"/>
  <w:LsdException Locked="false" Priority="67" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 1 Accent 2"/>
  <w:LsdException Locked="false" Priority="68" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 2 Accent 2"/>
  <w:LsdException Locked="false" Priority="69" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 3 Accent 2"/>
  <w:LsdException Locked="false" Priority="70" SemiHidden="false"
   UnhideWhenUsed="false" Name="Dark List Accent 2"/>
  <w:LsdException Locked="false" Priority="71" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful Shading Accent 2"/>
  <w:LsdException Locked="false" Priority="72" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful List Accent 2"/>
  <w:LsdException Locked="false" Priority="73" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful Grid Accent 2"/>
  <w:LsdException Locked="false" Priority="60" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light Shading Accent 3"/>
  <w:LsdException Locked="false" Priority="61" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light List Accent 3"/>
  <w:LsdException Locked="false" Priority="62" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light Grid Accent 3"/>
  <w:LsdException Locked="false" Priority="63" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Shading 1 Accent 3"/>
  <w:LsdException Locked="false" Priority="64" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Shading 2 Accent 3"/>
  <w:LsdException Locked="false" Priority="65" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium List 1 Accent 3"/>
  <w:LsdException Locked="false" Priority="66" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium List 2 Accent 3"/>
  <w:LsdException Locked="false" Priority="67" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 1 Accent 3"/>
  <w:LsdException Locked="false" Priority="68" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 2 Accent 3"/>
  <w:LsdException Locked="false" Priority="69" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 3 Accent 3"/>
  <w:LsdException Locked="false" Priority="70" SemiHidden="false"
   UnhideWhenUsed="false" Name="Dark List Accent 3"/>
  <w:LsdException Locked="false" Priority="71" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful Shading Accent 3"/>
  <w:LsdException Locked="false" Priority="72" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful List Accent 3"/>
  <w:LsdException Locked="false" Priority="73" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful Grid Accent 3"/>
  <w:LsdException Locked="false" Priority="60" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light Shading Accent 4"/>
  <w:LsdException Locked="false" Priority="61" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light List Accent 4"/>
  <w:LsdException Locked="false" Priority="62" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light Grid Accent 4"/>
  <w:LsdException Locked="false" Priority="63" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Shading 1 Accent 4"/>
  <w:LsdException Locked="false" Priority="64" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Shading 2 Accent 4"/>
  <w:LsdException Locked="false" Priority="65" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium List 1 Accent 4"/>
  <w:LsdException Locked="false" Priority="66" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium List 2 Accent 4"/>
  <w:LsdException Locked="false" Priority="67" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 1 Accent 4"/>
  <w:LsdException Locked="false" Priority="68" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 2 Accent 4"/>
  <w:LsdException Locked="false" Priority="69" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 3 Accent 4"/>
  <w:LsdException Locked="false" Priority="70" SemiHidden="false"
   UnhideWhenUsed="false" Name="Dark List Accent 4"/>
  <w:LsdException Locked="false" Priority="71" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful Shading Accent 4"/>
  <w:LsdException Locked="false" Priority="72" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful List Accent 4"/>
  <w:LsdException Locked="false" Priority="73" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful Grid Accent 4"/>
  <w:LsdException Locked="false" Priority="60" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light Shading Accent 5"/>
  <w:LsdException Locked="false" Priority="61" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light List Accent 5"/>
  <w:LsdException Locked="false" Priority="62" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light Grid Accent 5"/>
  <w:LsdException Locked="false" Priority="63" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Shading 1 Accent 5"/>
  <w:LsdException Locked="false" Priority="64" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Shading 2 Accent 5"/>
  <w:LsdException Locked="false" Priority="65" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium List 1 Accent 5"/>
  <w:LsdException Locked="false" Priority="66" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium List 2 Accent 5"/>
  <w:LsdException Locked="false" Priority="67" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 1 Accent 5"/>
  <w:LsdException Locked="false" Priority="68" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 2 Accent 5"/>
  <w:LsdException Locked="false" Priority="69" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 3 Accent 5"/>
  <w:LsdException Locked="false" Priority="70" SemiHidden="false"
   UnhideWhenUsed="false" Name="Dark List Accent 5"/>
  <w:LsdException Locked="false" Priority="71" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful Shading Accent 5"/>
  <w:LsdException Locked="false" Priority="72" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful List Accent 5"/>
  <w:LsdException Locked="false" Priority="73" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful Grid Accent 5"/>
  <w:LsdException Locked="false" Priority="60" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light Shading Accent 6"/>
  <w:LsdException Locked="false" Priority="61" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light List Accent 6"/>
  <w:LsdException Locked="false" Priority="62" SemiHidden="false"
   UnhideWhenUsed="false" Name="Light Grid Accent 6"/>
  <w:LsdException Locked="false" Priority="63" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Shading 1 Accent 6"/>
  <w:LsdException Locked="false" Priority="64" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Shading 2 Accent 6"/>
  <w:LsdException Locked="false" Priority="65" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium List 1 Accent 6"/>
  <w:LsdException Locked="false" Priority="66" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium List 2 Accent 6"/>
  <w:LsdException Locked="false" Priority="67" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 1 Accent 6"/>
  <w:LsdException Locked="false" Priority="68" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 2 Accent 6"/>
  <w:LsdException Locked="false" Priority="69" SemiHidden="false"
   UnhideWhenUsed="false" Name="Medium Grid 3 Accent 6"/>
  <w:LsdException Locked="false" Priority="70" SemiHidden="false"
   UnhideWhenUsed="false" Name="Dark List Accent 6"/>
  <w:LsdException Locked="false" Priority="71" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful Shading Accent 6"/>
  <w:LsdException Locked="false" Priority="72" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful List Accent 6"/>
  <w:LsdException Locked="false" Priority="73" SemiHidden="false"
   UnhideWhenUsed="false" Name="Colorful Grid Accent 6"/>
  <w:LsdException Locked="false" Priority="19" SemiHidden="false"
   UnhideWhenUsed="false" QFormat="true" Name="Subtle Emphasis"/>
  <w:LsdException Locked="false" Priority="21" SemiHidden="false"
   UnhideWhenUsed="false" QFormat="true" Name="Intense Emphasis"/>
  <w:LsdException Locked="false" Priority="31" SemiHidden="false"
   UnhideWhenUsed="false" QFormat="true" Name="Subtle Reference"/>
  <w:LsdException Locked="false" Priority="32" SemiHidden="false"
   UnhideWhenUsed="false" QFormat="true" Name="Intense Reference"/>
  <w:LsdException Locked="false" Priority="33" SemiHidden="false"
   UnhideWhenUsed="false" QFormat="true" Name="Book Title"/>
  <w:LsdException Locked="false" Priority="37" Name="Bibliography"/>
  <w:LsdException Locked="false" Priority="39" QFormat="true" Name="TOC Heading"/>
 </w:LatentStyles>
</xml><![endif]-->
<style>
<!--
 /* Font Definitions */
 @font-face
	{font-family:新細明體;
	panose-1:2 2 5 0 0 0 0 0 0 0;
	mso-font-alt:PMingLiU;
	mso-font-charset:136;
	mso-generic-font-family:roman;
	mso-font-pitch:variable;
	mso-font-signature:-1610611969 684719354 22 0 1048577 0;}
@font-face
	{font-family:新細明體;
	panose-1:2 2 5 0 0 0 0 0 0 0;
	mso-font-alt:PMingLiU;
	mso-font-charset:136;
	mso-generic-font-family:roman;
	mso-font-pitch:variable;
	mso-font-signature:-1610611969 684719354 22 0 1048577 0;}
@font-face
	{font-family:Calibri;
	panose-1:2 15 5 2 2 2 4 3 2 4;
	mso-font-charset:0;
	mso-generic-font-family:swiss;
	mso-font-pitch:variable;
	mso-font-signature:-536859905 -1073732485 9 0 511 0;}
@font-face
	{font-family:"\@新細明體";
	panose-1:2 2 5 0 0 0 0 0 0 0;
	mso-font-charset:136;
	mso-generic-font-family:roman;
	mso-font-pitch:variable;
	mso-font-signature:-1610611969 684719354 22 0 1048577 0;}
 /* Style Definitions */
 p.MsoNormal, li.MsoNormal, div.MsoNormal
	{mso-style-unhide:no;
	mso-style-qformat:yes;
	mso-style-parent:"";
	margin:0cm;
	margin-bottom:.0001pt;
	mso-pagination:none;
	font-size:12.0pt;
	mso-bidi-font-size:11.0pt;
	font-family:"Calibri","sans-serif";
	mso-ascii-font-family:Calibri;
	mso-ascii-theme-font:minor-latin;
	mso-fareast-font-family:新細明體;
	mso-fareast-theme-font:minor-fareast;
	mso-hansi-font-family:Calibri;
	mso-hansi-theme-font:minor-latin;
	mso-bidi-font-family:"Times New Roman";
	mso-bidi-theme-font:minor-bidi;
	mso-font-kerning:1.0pt;}
p.MsoCommentText, li.MsoCommentText, div.MsoCommentText
	{mso-style-noshow:yes;
	mso-style-priority:99;
	mso-style-link:"註解文字 字元";
	margin:0cm;
	margin-bottom:.0001pt;
	mso-pagination:none;
	font-size:12.0pt;
	mso-bidi-font-size:11.0pt;
	font-family:"Calibri","sans-serif";
	mso-ascii-font-family:Calibri;
	mso-ascii-theme-font:minor-latin;
	mso-fareast-font-family:新細明體;
	mso-fareast-theme-font:minor-fareast;
	mso-hansi-font-family:Calibri;
	mso-hansi-theme-font:minor-latin;
	mso-bidi-font-family:"Times New Roman";
	mso-bidi-theme-font:minor-bidi;
	mso-font-kerning:1.0pt;}
span.MsoCommentReference
	{mso-style-noshow:yes;
	mso-style-priority:99;
	mso-ansi-font-size:9.0pt;
	mso-bidi-font-size:9.0pt;}
p.MsoCommentSubject, li.MsoCommentSubject, div.MsoCommentSubject
	{mso-style-noshow:yes;
	mso-style-priority:99;
	mso-style-parent:註解文字;
	mso-style-link:"註解主旨 字元";
	mso-style-next:註解文字;
	margin:0cm;
	margin-bottom:.0001pt;
	mso-pagination:none;
	font-size:12.0pt;
	mso-bidi-font-size:11.0pt;
	font-family:"Calibri","sans-serif";
	mso-ascii-font-family:Calibri;
	mso-ascii-theme-font:minor-latin;
	mso-fareast-font-family:新細明體;
	mso-fareast-theme-font:minor-fareast;
	mso-hansi-font-family:Calibri;
	mso-hansi-theme-font:minor-latin;
	mso-bidi-font-family:"Times New Roman";
	mso-bidi-theme-font:minor-bidi;
	mso-font-kerning:1.0pt;
	font-weight:bold;}
p.MsoAcetate, li.MsoAcetate, div.MsoAcetate
	{mso-style-noshow:yes;
	mso-style-priority:99;
	mso-style-link:"註解方塊文字 字元";
	margin:0cm;
	margin-bottom:.0001pt;
	mso-pagination:none;
	font-size:9.0pt;
	font-family:"Cambria","serif";
	mso-ascii-font-family:Cambria;
	mso-ascii-theme-font:major-latin;
	mso-fareast-font-family:新細明體;
	mso-fareast-theme-font:major-fareast;
	mso-hansi-font-family:Cambria;
	mso-hansi-theme-font:major-latin;
	mso-bidi-font-family:"Times New Roman";
	mso-bidi-theme-font:major-bidi;
	mso-font-kerning:1.0pt;}
span.a
	{mso-style-name:"註解文字 字元";
	mso-style-noshow:yes;
	mso-style-priority:99;
	mso-style-unhide:no;
	mso-style-locked:yes;
	mso-style-link:註解文字;}
span.a0
	{mso-style-name:"註解主旨 字元";
	mso-style-noshow:yes;
	mso-style-priority:99;
	mso-style-unhide:no;
	mso-style-locked:yes;
	mso-style-parent:"註解文字 字元";
	mso-style-link:註解主旨;
	font-weight:bold;}
span.a1
	{mso-style-name:"註解方塊文字 字元";
	mso-style-noshow:yes;
	mso-style-priority:99;
	mso-style-unhide:no;
	mso-style-locked:yes;
	mso-style-link:註解方塊文字;
	mso-ansi-font-size:9.0pt;
	mso-bidi-font-size:9.0pt;
	font-family:"Cambria","serif";
	mso-ascii-font-family:Cambria;
	mso-ascii-theme-font:major-latin;
	mso-fareast-font-family:新細明體;
	mso-fareast-theme-font:major-fareast;
	mso-hansi-font-family:Cambria;
	mso-hansi-theme-font:major-latin;
	mso-bidi-font-family:"Times New Roman";
	mso-bidi-theme-font:major-bidi;}
span.SpellE
	{mso-style-name:"";
	mso-spl-e:yes;}
span.GramE
	{mso-style-name:"";
	mso-gram-e:yes;}
.MsoChpDefault
	{mso-style-type:export-only;
	mso-default-props:yes;
	font-family:"Calibri","sans-serif";
	mso-bidi-font-family:"Times New Roman";
	mso-bidi-theme-font:minor-bidi;}
 /* Page Definitions */
 @page
	{mso-page-border-surround-header:no;
	mso-page-border-surround-footer:no;}
@page WordSection1
	{size:595.3pt 841.9pt;
	margin:72.0pt 90.0pt 72.0pt 90.0pt;
	mso-header-margin:42.55pt;
	mso-footer-margin:49.6pt;
	mso-paper-source:0;
	layout-grid:18.0pt;}
div.WordSection1
	{page:WordSection1;}
-->
</style>
<!--[if gte mso 10]>
<style>
 /* Style Definitions */
 table.MsoNormalTable
	{mso-style-name:表格內文;
	mso-tstyle-rowband-size:0;
	mso-tstyle-colband-size:0;
	mso-style-noshow:yes;
	mso-style-priority:99;
	mso-style-parent:"";
	mso-padding-alt:0cm 5.4pt 0cm 5.4pt;
	mso-para-margin:0cm;
	mso-para-margin-bottom:.0001pt;
	mso-pagination:widow-orphan;
	font-size:12.0pt;
	mso-bidi-font-size:11.0pt;
	font-family:"Calibri","sans-serif";
	mso-ascii-font-family:Calibri;
	mso-ascii-theme-font:minor-latin;
	mso-hansi-font-family:Calibri;
	mso-hansi-theme-font:minor-latin;
	mso-bidi-font-family:"Times New Roman";
	mso-bidi-theme-font:minor-bidi;
	mso-font-kerning:1.0pt;}
</style>
<![endif]--><!--[if gte mso 9]><xml>
 <o:shapedefaults v:ext="edit" spidmax="1026"/>
</xml><![endif]--><!--[if gte mso 9]><xml>
 <o:shapelayout v:ext="edit">
  <o:idmap v:ext="edit" data="1"/>
 </o:shapelayout></xml><![endif]-->
</head>

<body lang=ZH-TW style='tab-interval:24.0pt;text-justify-trim:punctuation'>

<div class=WordSection1 style='layout-grid:18.0pt'>

<p class=MsoNormal><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>作業系統報告</span></p>

<p class=MsoNormal><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>四資工三</span><span lang=EN-US><span style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='mso-spacerun:yes'>&nbsp; </span><span style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>B10415024<span
style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>
<span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='mso-spacerun:yes'>&nbsp;&nbsp;&nbsp;</span><span style='mso-tab-count:
1'>&nbsp; </span></span><span class=GramE><span style='text-fit:36.0pt;
mso-text-fit-id:1516612864'><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin;mso-font-kerning:0pt'>廖珮</span></span></span><span
style='text-fit:36.0pt;mso-text-fit-id:1516612864'><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin;mso-font-kerning:0pt'>均</span></span></p>

<p class=MsoNormal><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><span class=SpellE><b style='mso-bidi-font-weight:normal'><span
lang=EN-US style='font-size:14.0pt;mso-bidi-font-size:11.0pt'>Chaper</span></b></span><b
style='mso-bidi-font-weight:normal'><span lang=EN-US style='font-size:14.0pt;
mso-bidi-font-size:11.0pt'> 2<o:p></o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span lang=EN-US
style='font-size:14.0pt;mso-bidi-font-size:11.0pt'><o:p>&nbsp;</o:p></span></b></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span lang=EN-US>Page
tables<o:p></o:p></span></b></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>Page tables</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>是作業系統控制記憶體位址的機制。它們允許</span><span lang=EN-US>xv6</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>在一個實體記憶體上有多個不同</span><span
lang=EN-US>process</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>的記憶體空間，和去保護不同</span><span lang=EN-US>process</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>的記憶體。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>配對</span><span
lang=EN-US>kernel</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>相同的記憶體在很多的記憶體空間，配對多於一個的相同的記憶體在一個記憶體空間，用一個沒配對的</span><span
lang=EN-US>page</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>保護一個使用者堆疊。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span lang=EN-US>Paging
hardware<o:p></o:p></span></b></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>X86</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>指令操作虛擬地址。機器的</span><span lang=EN-US>RAM</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>或是實體記憶體被實體地址索引。</span><span
lang=EN-US>X86 page table</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>硬體連接兩種地址，藉由配對每一個虛擬地址到時地址。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>一個</span><span
lang=EN-US>x86 page table</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>是</span><span lang=EN-US>2^20 (1,048,576)
page table entries(PTEs)</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>。每一個</span><span lang=EN-US>PTE</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>包含一個</span><span
lang=EN-US>20bits</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>實體</span><span lang=EN-US>page number(PPN)</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>和一些旗幟。這個</span><span
lang=EN-US>paging</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>硬體藉由它的前</span><span lang=EN-US>20bits</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>到</span><span
lang=EN-US>page table</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>去尋找</span><span lang=EN-US>PTE</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>來翻譯一個虛擬地址，和取代地址的前</span><span
lang=EN-US>20bis</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>和在</span><span lang=EN-US>PTE</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>的</span><span lang=EN-US>PPN</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>。</span><span
lang=EN-US>Page </span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>硬體從虛擬到翻譯的實體地址不變地複製後面</span><span lang=EN-US>12bits</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>。因此</span><span
lang=EN-US>page table</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>給作業系統控制在虛擬到實體地址翻譯在對齊的粒度</span><span lang=EN-US>4096bytes</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>的</span><span
lang=EN-US>chunks</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>。每一個</span><span lang=EN-US>chunk</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>稱為一個</span><span lang=EN-US>page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>一個</span><span
lang=EN-US>page table</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>像兩層樹被儲存在實體記憶體。樹的根是一個</span><span lang=EN-US>4096bytes</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>的</span><span
lang=EN-US>page directory</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>包含</span><span lang=EN-US>1024 PTE-like </span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>引用到</span><span
lang=EN-US>page table pages</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>。每一個</span><span lang=EN-US>page table page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>是一個</span><span
lang=EN-US>1024 32bits PTEs</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>的陣列。</span><span lang=EN-US>Paging</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>硬體使用虛擬地址的前</span><span
lang=EN-US>10bits</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>去選擇一個</span><span lang=EN-US>PTE</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>從</span><span lang=EN-US>page table
page</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>是</span><span
lang=EN-US>page directory</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>引用。如果不是</span><span lang=EN-US>page directory</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>進入也不是</span><span
lang=EN-US>PTE</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>，</span><span lang=EN-US>paging </span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>硬體造成一個錯誤。這個兩層的結構允許一個</span><span
lang=EN-US>page table</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>去忽略全部的</span><span lang=EN-US>page table pages</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>在常態大範圍的虛擬記憶體沒有配對。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>每<span
class=GramE>個</span></span><span lang=EN-US>PTE</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>包含旗幟的</span><span lang=EN-US>bit</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>來告訴</span><span
lang=EN-US>paging</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>硬體如何相關虛擬地址被允許使用。</span><span lang=EN-US>PTE_P</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>指是否</span><span
lang=EN-US>PTE</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>是當下：如果它沒有設定，一個參考到</span><span lang=EN-US>page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>造成一個錯誤。</span><span
lang=EN-US>PTE_W</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>控制指令是否被允許去寫入</span><span lang=EN-US>page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>；如果沒有設定，只有讀和取指令被允許。</span><span
lang=EN-US>PTE_U</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>控制使用者程式是否允許去使用</span><span lang=EN-US>page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>；如果<span
class=GramE>清楚，</span>只有</span><span lang=EN-US>kernel</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>被允許去使用</span><span
lang=EN-US>Page</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>。旗標和所有其他</span><span lang=EN-US>page</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>硬體相關結構被定義在</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>Mmu.h</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span lang=EN-US>0700):</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>//</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>檔案包含定義</span><span lang=EN-US>x86</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>記憶體管理單元</span><span
lang=EN-US>(MMU)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// <span class=SpellE>Eflags</span> register</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_CF 0x00000001 // Carry Flag</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_PF 0x00000004 // Parity Flag</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_AF 0x00000010 // Auxiliary carry Flag</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_ZF 0x00000040 // Zero Flag</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_SF 0x00000080 // Sign Flag</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_TF 0x00000100 // Trap Flag</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_IF 0x00000200 // Interrupt Enable</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_DF 0x00000400 // Direction Flag</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_OF 0x00000800 // Overflow Flag</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_IOPL_MASK 0x00003000 // I/O Privilege
Level bitmask</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_IOPL_0 0x00000000 // IOPL == 0</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_IOPL_1 0x00001000 // IOPL == 1</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_IOPL_2 0x00002000 // IOPL == 2</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_IOPL_3 0x00003000 // IOPL == 3</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_NT 0x00004000 // Nested Task</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_RF 0x00010000 // Resume Flag</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_VM 0x00020000 // Virtual 8086 mode</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_AC 0x00040000 // Alignment Check</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_VIF 0x00080000 // Virtual Interrupt Flag</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_VIP 0x00100000 // Virtual Interrupt
Pending</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define FL_ID 0x00200000 // ID flag</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// Control Register flags</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define CR0_PE 0x00000001 // Protection Enable</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define CR0_MP 0x00000002 // Monitor <span
class=SpellE>coProcessor</span></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define CR0_EM 0x00000004 // Emulation</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define CR0_TS 0x00000008 // Task Switched</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define CR0_ET 0x00000010 // Extension Type</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define CR0_NE 0x00000020 // Numeric <span
class=SpellE>Errror</span></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define CR0_WP 0x00010000 // Write Protect</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define CR0_AM 0x00040000 // Alignment Mask</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define CR0_NW 0x20000000 // Not <span class=SpellE>Writethrough</span></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define CR0_CD 0x40000000 // Cache Disable</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define CR0_PG 0x80000000 // Paging</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define CR4_PSE 0x00000010 // Page size extension</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// </span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>不同片段選擇</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define SEG_KCODE 1 // kernel code</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define SEG_KDATA 2 // kernel <span class=SpellE>data+stack</span></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define SEG_UCODE 3 // user code</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define SEG_UDATA 4 // user <span class=SpellE>data+stack</span></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define SEG_TSS 5 // this process’s task state</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// <span class=SpellE>cpu</span>&#8722;&gt;<span
class=SpellE>gdt</span>[NSEGS] </span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>保存以上的片段</span><span lang=EN-US>.</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define NSEGS 6</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#<span class=SpellE>ifndef</span> __ASSEMBLER__</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// Segment Descriptor</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>struct</span></span></span><span
lang=EN-US> <span class=SpellE>segdesc</span> {</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> lim_15_0 : 16; // Low bits of
segment limit</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> base_15_0 : 16; // Low bits
of segment base address</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> base_23_16 : 8; // Middle
bits of segment base address</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> type : 4; // Segment type
(see STS_ constants)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> s : 1; // 0 = system, 1 =
application</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>dpl</span>
: 2; // Descriptor Privilege Level</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> p : 1; // Present</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> lim_19_16 : 4; // High bits
of segment limit</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>avl</span>
: 1; // Unused (available for software use)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> rsv1 : 1; // Reserved</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>db</span>
: 1; // 0 = 16&#8722;bit segment, 1 = 32&#8722;bit segment</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> g : 1; // Granularity: limit
scaled by 4K when set</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> base_31_24 : 8; // High bits
of segment base address</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>};</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// Normal segment</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define <span class=GramE>SEG(</span>type, base, <span
class=SpellE>lim</span>, <span class=SpellE>dpl</span>) (<span class=SpellE>struct</span>
<span class=SpellE>segdesc</span>) \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=GramE><span lang=EN-US>{ (</span></span><span lang=EN-US>(<span
class=SpellE>lim</span>) &gt;&gt; 12) &amp; 0xffff, (<span class=SpellE>uint</span>)(base)
&amp; 0xffff, \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>((<span class=SpellE><span class=GramE>uint</span></span>)(base)
&gt;&gt; 16) &amp; 0xff, type, 1, <span class=SpellE>dpl</span>, 1, \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>(<span class=SpellE><span class=GramE>uint</span></span>)(<span
class=SpellE><span class=GramE>lim</span></span>) &gt;&gt; 28, 0, 0, 1, 1, (<span
class=SpellE>uint</span>)(base) &gt;&gt; 24 }</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define <span class=GramE>SEG16(</span>type, base, <span
class=SpellE>lim</span>, <span class=SpellE>dpl</span>) (<span class=SpellE>struct</span>
<span class=SpellE>segdesc</span>) \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=GramE><span lang=EN-US>{ (</span></span><span
class=SpellE><span lang=EN-US>lim</span></span><span lang=EN-US>) &amp; 0xffff,
(<span class=SpellE>uint</span>)(base) &amp; 0xffff, \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>((<span class=SpellE><span class=GramE>uint</span></span>)(base)
&gt;&gt; 16) &amp; 0xff, type, 1, <span class=SpellE>dpl</span>, 1, \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>(<span class=SpellE><span class=GramE>uint</span></span>)(<span
class=SpellE><span class=GramE>lim</span></span>) &gt;&gt; 16, 0, 0, 1, 0, (<span
class=SpellE>uint</span>)(base) &gt;&gt; 24 }</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#<span class=SpellE>endif</span></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define DPL_USER 0x3 // User DPL</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// Application segment type bits</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STA_X 0x8 // </span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>可執行片段</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STA_E 0x4 // Expand down (non&#8722;executable
segments)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STA_C 0x4 // Conforming code segment (executable
only)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STA_W 0x2 // </span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>可寫</span><span lang=EN-US>(non&#8722;executable
segments)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STA_R 0x2 // </span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>可讀</span><span lang=EN-US>(executable
segments)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STA_A 0x1 // Accessed</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// System segment type bits</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STS_T16A 0x1 // Available 16&#8722;bit TSS</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STS_LDT 0x2 // Local Descriptor Table</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STS_T16B 0x3 // Busy 16&#8722;bit TSS</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STS_CG16 0x4 // 16&#8722;bit Call Gate</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STS_TG 0x5 // Task Gate / <span class=SpellE>Coum</span>
<span class=SpellE>Transmitions</span></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STS_IG16 0x6 // 16&#8722;bit Interrupt Gate</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STS_TG16 0x7 // 16&#8722;bit Trap Gate</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STS_T32A 0x9 // Available 32&#8722;bit TSS</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STS_T32B 0xB // Busy 32&#8722;bit TSS</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STS_CG32 0xC // 32&#8722;bit Call Gate</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STS_IG32 0xE // 32&#8722;bit Interrupt Gate</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define STS_TG32 0xF // 32&#8722;bit Trap Gate</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// </span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>虛擬地址</span><span lang=EN-US> <span
class=GramE>’</span>la<span class=GramE>’</span> </span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>有三個部分</span><span lang=EN-US>:</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>//</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>//
+&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;10&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;+&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;10&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;+&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;12&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;+</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// | Page Directory | Page Table | Offset within Page
|</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// | Index | Index | |</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// +&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;+&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;+&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;&#8722;+</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// \&#8722;&#8722;&#8722; <span class=GramE>PDX(</span><span
class=SpellE>va</span>) &#8722;&#8722;/ \&#8722;&#8722;&#8722; PTX(<span class=SpellE>va</span>) &#8722;&#8722;/</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// page directory index</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define <span class=GramE>PDX(</span><span
class=SpellE>va</span>) (((<span class=SpellE>uint</span>)(<span class=SpellE>va</span>)
&gt;&gt; PDXSHIFT) &amp; 0x3FF)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// page table index</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define <span class=GramE>PTX(</span><span
class=SpellE>va</span>) (((<span class=SpellE>uint</span>)(<span class=SpellE>va</span>)
&gt;&gt; PTXSHIFT) &amp; 0x3FF)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>//</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>從</span><span lang=EN-US>indexes and offset</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>建構虛擬地址</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define <span class=GramE>PGADDR(</span>d, t, o) ((<span
class=SpellE>uint</span>)((d) &lt;&lt; PDXSHIFT | (t) &lt;&lt; PTXSHIFT | (o)))</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// Page directory and page table constants.</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define NPDENTRIES 1024 // # directory entries per
page directory</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define NPTENTRIES 1024 // # PTEs per page table</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define PGSIZE 4096 // bytes mapped by a page</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define PGSHIFT 12 // <span class=GramE>log2(</span>PGSIZE)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define PTXSHIFT 12 // offset of PTX in a linear
address</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define PDXSHIFT 22 // offset of PDX in a linear
address</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define <span class=GramE>PGROUNDUP(</span><span
class=SpellE>sz</span>) (((<span class=SpellE>sz</span>)+PGSIZE&#8722;1) &amp;
~(PGSIZE&#8722;1))</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define <span class=GramE>PGROUNDDOWN(</span>a)
(((a)) &amp; ~(PGSIZE&#8722;1))</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// Page table/directory entry flags.</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define PTE_P 0x001 // Present</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define PTE_W 0x002 // Writeable</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define PTE_U 0x004 // User</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define PTE_PWT 0x008 // Write&#8722;Through</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define PTE_PCD 0x010 // Cache&#8722;Disable</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define PTE_A 0x020 // Accessed</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define PTE_D 0x040 // Dirty</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define PTE_PS 0x080 // Page Size</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define PTE_MBZ 0x180 // Bits must be zero</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// Address in page table or page directory entry</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define PTE_<span class=GramE>ADDR(</span><span
class=SpellE>pte</span>) ((<span class=SpellE>uint</span>)(<span class=SpellE>pte</span>)
&amp; ~0xFFF)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define PTE_<span class=GramE>FLAGS(</span><span
class=SpellE>pte</span>) ((<span class=SpellE>uint</span>)(<span class=SpellE>pte</span>)
&amp; 0xFFF)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#<span class=SpellE>ifndef</span> __ASSEMBLER__</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>typedef</span></span></span><span
lang=EN-US> <span class=SpellE>uint</span> <span class=SpellE>pte_t</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// Task state segment format</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>struct</span></span></span><span
lang=EN-US> <span class=SpellE>taskstate</span> {</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> link; // Old <span
class=SpellE>ts</span> selector</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> esp0; // Stack pointers and
segment selectors</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> ss0; // after an increase
in privilege level</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> padding1;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> *esp1;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> ss1;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> padding2;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> *esp2;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> ss2;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> padding3;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>void</span> *cr3; // Page directory base</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> *<span class=SpellE>eip</span>;
// Saved state from last task switch</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>eflags</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>eax</span>;
// More saved state (registers)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>ecx</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>edx</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>ebx</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> *<span class=SpellE>esp</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> *<span class=SpellE>ebp</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>esi</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>edi</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> <span class=SpellE>es</span>;
// Even more saved state (segment selectors)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> padding4;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> <span class=SpellE>cs</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> padding5;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> <span class=SpellE>ss</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> padding6;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> ds;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> padding7;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> fs;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> padding8;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> <span class=SpellE>gs</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> padding9;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> <span class=SpellE>ldt</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> padding10;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> t; // Trap on task switch</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> <span class=SpellE>iomb</span>;
// I/O map base address</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>};</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>…</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// Gate descriptors for interrupts and traps</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>struct</span></span></span><span
lang=EN-US> <span class=SpellE>gatedesc</span> {</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> off_15_0 : 16; // low 16 bits
of offset in segment</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>cs</span>
: 16; // code segment selector</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>args</span>
: 5; // # <span class=SpellE>args</span>, 0 for interrupt/trap gates</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> rsv1 : 3; // reserved(should
be zero I guess)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> type : 4; //
type(STS_{TG,IG32,TG32})</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> s : 1; // must be 0 (system)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>dpl</span>
: 2; // descriptor(meaning new) privilege level</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> p : 1; // Present</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> off_31_16 : 16; // high bits
of offset in segment</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>};</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// Set up a normal interrupt/trap gate descriptor.</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// &#8722; <span class=SpellE>istrap</span>: 1 for a trap
(= exception) gate, 0 for an interrupt gate.</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// interrupt gate clears FL_IF, trap gate leaves
FL_IF alone</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// &#8722; <span class=SpellE>sel</span>: Code segment
selector for interrupt/trap handler</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// &#8722; off: Offset in code segment for interrupt/trap
handler</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// &#8722; <span class=SpellE>dpl</span>: Descriptor
Privilege Level &#8722;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// the privilege level required for software to
invoke</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// this interrupt/trap gate explicitly using an <span
class=SpellE>int</span> instruction.</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define <span class=GramE>SETGATE(</span>gate, <span
class=SpellE>istrap</span>, <span class=SpellE>sel</span>, off, d) \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>{ \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>(<span class=GramE>gate</span>).off_15_0 = (<span
class=SpellE>uint</span>)(off) &amp; 0xffff; \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>(<span class=GramE>gate</span>).<span class=SpellE>cs</span>
= (<span class=SpellE>sel</span>); \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>(<span class=GramE>gate</span>).<span class=SpellE>args</span>
= 0; \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>(<span class=GramE>gate</span>).rsv1 = 0; \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>(<span class=GramE>gate</span>).type = (<span
class=SpellE>istrap</span>) ? STS_<span class=GramE>TG32 :</span> STS_IG32; \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>(<span class=GramE>gate</span>).s = 0; \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>(<span class=GramE>gate</span>).<span class=SpellE>dpl</span>
= (d); \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>(<span class=GramE>gate</span>).p = 1; \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>(<span class=GramE>gate</span>).off_31_16 = (<span
class=SpellE>uint</span>)(off) &gt;&gt; 16; \</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#<span class=SpellE>endif</span></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>實體的記憶體指向儲存在</span><span
lang=EN-US>DRAM</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>。一個</span><span lang=EN-US>byte</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>的實體記憶體有一個地址稱為實體地址。指令只有使用虛擬地址是</span><span
lang=EN-US>paging</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>硬體翻譯到實體地址，送到</span><span lang=EN-US>DRAM</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>硬體去讀和寫儲存。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span lang=EN-US>Process
address space<o:p></o:p></span></b></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>Page table</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>創造藉由</span><span lang=EN-US>entry</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>已經足夠配對去允許</span><span
lang=EN-US>kernel</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>的</span><span lang=EN-US>C</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>程式碼去開始執行。然而</span><span lang=EN-US>main</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>立刻改變去一個新的</span><span
lang=EN-US>page table</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>藉由呼叫</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>kvmalloc</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span lang=EN-US>1840):</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>//</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>創造和切換一個</span><span lang=EN-US>Page table</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>用配對在</span><span
lang=EN-US>KERNBASE</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>上需要給</span><span lang=EN-US>kernel</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>去執行</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>kvmalloc</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span lang=EN-US>void)<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>{</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>kpgdir</span></span> = <span class=SpellE>setupkvm</span>();</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>switchkvm</span></span><span class=GramE>(</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>因為</span><span
lang=EN-US>kernel</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>已經有一個更多闡述計畫去描述</span><span lang=EN-US>process</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>地址空間。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>每一個</span><span
lang=EN-US>process</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>有一個分散</span><span lang=EN-US>page table</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>，和</span><span
lang=EN-US>xv6</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>告訴</span><span lang=EN-US>page table</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>硬體去切換</span><span lang=EN-US>page
tables</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>當</span><span lang=EN-US>xv6</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>切換在</span><span lang=EN-US>process</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>間。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>Memlayout.h</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span lang=EN-US>0200):</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// Memory layout</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define EXTMEM 0x100000 // Start of extended memory</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define PHYSTOP 0xE000000 // Top physical memory</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define DEVSPACE 0xFE000000 // <span class=GramE>Other</span>
devices are at high addresses</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>// Key addresses for address space layout (see <span
class=SpellE>kmap</span> in <span class=SpellE>vm.c</span> for layout)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define KERNBASE 0x80000000 // First kernel virtual
address</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define KERNLINK (KERNBASE+EXTMEM) // Address where kernel
is linked</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define <span class=GramE>V2P(</span>a) (((<span
class=SpellE>uint</span>) (a)) &#8722; KERNBASE)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define <span class=GramE>P2V(</span>a) (((void *)
(a)) + KERNBASE)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define V2P_WO(x) ((x) &#8722; KERNBASE) // same as V2P,
but without casts</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>#define P2V_WO(x) ((x) + KERNBASE) // same as P2V,
but without casts</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>當一個</span><span
lang=EN-US>process</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>問</span><span lang=EN-US>xv6</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>更多記憶體，</span><span lang=EN-US>xv6</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>第<span
class=GramE>一個找空的</span>實體</span><span lang=EN-US>page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>去提供，和增加</span><span
lang=EN-US>PTEs</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>到</span><span lang=EN-US>process</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>的</span><span lang=EN-US>page table</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>，指到新的記憶體</span><span
lang=EN-US>page</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>。</span><span lang=EN-US>Xv6</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>設定</span><span lang=EN-US>PTE_U,PTE_W</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>和</span><span
lang=EN-US>PTE_P</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>旗標在</span><span lang=EN-US>PTEs</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>。更多</span><span lang=EN-US>process</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>不能使用全部的使用者地址空間。</span><span
lang=EN-US>Xv6</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>留</span><span lang=EN-US>PTE_P</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>清除在沒使用的</span><span lang=EN-US>PTEs</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>。不同的</span><span
lang=EN-US>process</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>的</span><span lang=EN-US>page table</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>翻譯使用者地址到不同的實體記憶體的</span><span
lang=EN-US>page</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>，所以每一個</span><span lang=EN-US>process</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>都有各自使用者記憶體。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>Xv6</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>包含所有配對需要給</span><span lang=EN-US>kernel</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>去執行在每<span
class=GramE>個</span></span><span lang=EN-US>process</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>的</span><span
lang=EN-US>page table</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>；那些配對所有出現在</span><span lang=EN-US>KERNBASE</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>。它配對虛擬地址</span><span
lang=EN-US>KERN-BASE:KERNBASE+PHYSTOP to 0:PHYSTOP</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>。一個理由是這個配對是</span><span
lang=EN-US>kernel</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>可以使用它自己的指令和資料。另一個理由是</span><span lang=EN-US>kernel</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>有時候需要去寫一個實體記憶體的</span><span
lang=EN-US>page</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>，例如當創造</span><span lang=EN-US>page table pages</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>；有每<span
class=GramE>個</span>實體</span><span lang=EN-US>Page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>出現在可預測的虛擬地址。一個安排的缺陷是</span><span
lang=EN-US>sv6</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>不能使用多餘</span><span lang=EN-US>2GB</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>的實體記憶體。更多設備使用記憶體配對</span><span
lang=EN-US>I/O</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>出現在實體地址開始在</span><span lang=EN-US>0xFE00000</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>，所以</span><span
lang=EN-US>xv6 page table</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>包含一個直接配對給他們。</span><span lang=EN-US>Xv6</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>不能設定</span><span
lang=EN-US>PTE_U</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>旗標在</span><span lang=EN-US>KERN_BASE</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>上的</span><span lang=EN-US>PTEs</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>，所以只有</span><span
lang=EN-US>kernel</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>可以使用它們。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span lang=EN-US>Code:
creating an address space<o:p></o:p></span></b></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>Main</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>呼叫</span><span class=SpellE><span lang=EN-US>kvmalloc</span></span><span
lang=EN-US>(1840)</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>去創造和切換一個</span><span lang=EN-US>Page table</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>用配對在</span><span
lang=EN-US>KERNBASE</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>上需要給</span><span lang=EN-US>kernel</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>去執行。大多數工作發生在</span><span
class=SpellE><span lang=EN-US>setupkvm</span></span><span lang=EN-US>(1818):</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>setupkvm</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span lang=EN-US>void)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>{</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>pde_t</span> *<span class=SpellE>pgdir</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>struct</span></span> <span class=SpellE>kmap</span>
*k;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>配置一個</span><span
lang=EN-US>page</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>的記憶體來保存</span><span lang=EN-US>page directory</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>(<span class=SpellE>pgdir</span> = (<span class=SpellE>pde_t</span>*)<span
class=SpellE>kalloc</span>()) == 0)<span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='mso-spacerun:yes'>&nbsp;</span><span class=GramE>return</span> 0;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>memset</span></span><span class=GramE>(</span><span
class=SpellE>pgdir</span>, 0, PGSIZE);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if</span> (P2V(PHYSTOP) &gt; (void*)DEVSPACE)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>panic(</span>&quot;PHYSTOP too high&quot;);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>for(</span>k = <span class=SpellE>kmap</span>; k &lt; &amp;<span
class=SpellE>kmap</span>[NELEM(<span class=SpellE>kmap</span>)]; k++)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>呼叫</span><span
class=SpellE><span lang=EN-US>mappages</span></span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>去安裝</span><span lang=EN-US>kernel</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>需要的翻譯</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>mappages</span>(<span class=SpellE>pgdir</span>,
k&#8722;&gt;<span class=SpellE>virt</span>, k&#8722;&gt;<span class=SpellE>phys_end</span>
&#8722; k&#8722;&gt;<span class=SpellE>phys_start</span>,</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>(<span
class=SpellE><span class=GramE>uint</span></span><span class=GramE>)</span>k&#8722;&gt;<span
class=SpellE>phys_start</span>, k&#8722;&gt;perm) &lt; 0) {</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:4'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>freevm</span></span><span class=GramE>(</span><span
class=SpellE>pgdir</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:4'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>return</span> 0;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>return</span> <span class=SpellE>pgdir</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>在</span><span
class=SpellE><span lang=EN-US>kmap</span></span><span lang=EN-US>(1809):</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>kmap</span></span></span><span
class=GramE><span lang=EN-US>[</span></span><span lang=EN-US>] = {</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=GramE><span lang=EN-US>{ (</span></span><span lang=EN-US>void*)KERNBASE,
0, EXTMEM, PTE_W}, // I/O space</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=GramE><span lang=EN-US>{ (</span></span><span lang=EN-US>void*)KERNLINK,
V2P(KERNLINK), V2P(data), 0}, // kern <span class=SpellE>text+rodata</span></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=GramE><span lang=EN-US>{ (</span></span><span lang=EN-US>void*)data,
V2P(data), PHYSTOP, PTE_W}, // kern <span class=SpellE>data+memory</span></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=GramE><span lang=EN-US>{ (</span></span><span lang=EN-US>void*)DEVSPACE,
DEVSPACE, 0, PTE_W}, // more devices</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>};</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>這個包含</span><span
lang=EN-US>kernel</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>的指令和資料，實體記憶體到</span><span lang=EN-US>PHYSTOP</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>和實際上是</span><span
lang=EN-US>I/O</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>設備的記憶體範圍。</span><span class=SpellE><span lang=EN-US>Setupkvm</span></span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>不能安裝所有配對給使用者記憶體。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>Mappages</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span lang=EN-US>1760):</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>mappages</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span class=SpellE><span
lang=EN-US>pde_t</span></span><span lang=EN-US> *<span class=SpellE>pgdir</span>,
void *<span class=SpellE>va</span>, <span class=SpellE>uint</span> size, <span
class=SpellE>uint</span> pa, <span class=SpellE>int</span> perm)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>{</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>char</span> *a, *last;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>pte_t</span> *<span class=SpellE>pte</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>a
= (char*<span class=GramE>)PGROUNDDOWN</span>((<span class=SpellE>uint</span>)<span
class=SpellE>va</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>last</span> = (char*)PGROUNDDOWN(((<span class=SpellE>uint</span>)<span
class=SpellE>va</span>) + size &#8722; 1);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>for(</span>;;){</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>(<span class=SpellE>pte</span> = <span class=SpellE>walkpgdir</span>(<span
class=SpellE>pgdir</span>, a, 1)) == 0)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>return</span> &#8722;1;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>*<span class=SpellE>pte</span> &amp; PTE_P)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>panic(</span>&quot;remap&quot;);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>*<span
class=SpellE>pte</span> = pa | perm | PTE_P;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>a == last)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>break</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>a
+= PGSIZE;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>pa</span> += PGSIZE;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class=MsoNormal style='text-align:justify;text-justify:inter-ideograph;
text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:exactly'><span
lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>return</span> 0;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>安裝配對在</span><span
lang=EN-US>page table</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>給一個虛擬地址的範圍去對應實體地址的範圍。每一個虛擬地址被配對</span><span class=SpellE><span
lang=EN-US>mappages</span></span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>呼叫</span><span class=SpellE><span lang=EN-US>walkpgdir</span></span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>去尋找該地址的</span><span
lang=EN-US>PTE</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>的地址。它初始化</span><span lang=EN-US>PTE</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>去保存相應實體</span><span lang=EN-US>page
number</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>，所需的權限，和</span><span lang=EN-US>PTE_P</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>去標記</span><span
lang=EN-US>PTE</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>是</span><span lang=EN-US>valid(1772)</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>Walkpgdir</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span lang=EN-US>1735):</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>walkpgdir</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span class=SpellE><span
lang=EN-US>pde_t</span></span><span lang=EN-US> *<span class=SpellE>pgdir</span>,
<span class=SpellE>const</span> void *<span class=SpellE>va</span>, <span
class=SpellE>int</span> <span class=SpellE>alloc</span>)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>{</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>pde_t</span> *<span class=SpellE>pde</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>pte_t</span> *<span class=SpellE>pgtab</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>使用虛擬地址的上面</span><span
lang=EN-US>10bit</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>去尋找</span><span lang=EN-US>page directory entry</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>pde</span></span> = &amp;<span class=SpellE>pgdir</span>[PDX(<span
class=SpellE>va</span>)];</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>*<span class=SpellE>pde</span> &amp; PTE_P){</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>pgtab</span></span> = (<span class=SpellE>pte_t</span>*)P2V(PTE_ADDR(*<span
class=SpellE>pde</span>));</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>} else {</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>如果</span><span
lang=EN-US>page directory</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>不存在</span></p>

<p class=MsoNormal style='margin-left:72.0pt;text-indent:24.0pt;line-height:
16.0pt;mso-line-height-rule:exactly'><span lang=EN-US>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>則需要的</span><span
lang=EN-US>page table page</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>還沒被分配</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>!<span class=SpellE>alloc</span> || (<span class=SpellE>pgtab</span>
= (<span class=SpellE>pte_t</span>*)<span class=SpellE>kalloc</span>()) == 0)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>return</span> 0;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//
</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>確保所有</span><span
lang=EN-US>PTE_P bits</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>都是</span><span lang=EN-US>0</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>memset</span></span><span class=GramE>(</span><span
class=SpellE>pgtab</span>, 0, PGSIZE);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//
</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>這裡的權限過分慷慨</span><span
lang=EN-US>, </span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>但它們可以</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//
</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>進一步限制藉由權限進入</span><span
lang=EN-US>page table</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//,
</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>必要時</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>*<span
class=SpellE>pde</span> = <span class=GramE>V2P(</span><span class=SpellE>pgtab</span>)
| PTE_P | PTE_W | PTE_U;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>使用虛擬地址的下</span><span
lang=EN-US>10</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>個</span><span lang=EN-US>bit</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>去尋找在</span><span lang=EN-US>page table page
PTE</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>的地址</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>return</span> &amp;<span class=SpellE>pgtab</span>[PTX(<span
class=SpellE>va</span>)];</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>模仿</span><span
lang=EN-US>x86 paging</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>硬體的動作像它查詢</span><span lang=EN-US>PTE</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>一個虛擬地址。如果</span><span class=SpellE><span
lang=EN-US>alloc</span></span><span lang=EN-US> </span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>設定，</span><span class=SpellE><span
lang=EN-US>walkpgdir</span></span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>分配它和放它的實體地址在</span><span lang=EN-US>page
directory</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span lang=EN-US>Physical
memory allocation<o:p></o:p></span></b></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>Kernel</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>必須分配和釋放實體記憶體在執行時給</span><span lang=EN-US>page
table</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>、</span><span
lang=EN-US>process</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>使用者記憶體、</span><span lang=EN-US>kernel</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>堆疊和</span><span
lang=EN-US>Pipe buffers</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>Xv6</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>使用在</span><span lang=EN-US>kernel</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>和</span><span
lang=EN-US>PHYSTOP</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>之間的實體記憶體在執行時分配。它分配和釋放全部</span><span lang=EN-US>4096 bytes page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>在同一時間。它保持透過線程連接列表追蹤那些</span><span
lang=EN-US>page</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>。分配包含從一個連接列表移除一個</span><span lang=EN-US>Page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>；釋放包含增加空的</span><span
lang=EN-US>page</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>到列表。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span lang=EN-US>Code:
Physical memory allocator<o:p></o:p></span></b></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>分配的資料結構是實體記憶體</span><span
lang=EN-US>Pages</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>的釋放列表，是可以被分配。每一個空</span><span lang=EN-US>page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>的列表元素是</span><span
class=SpellE><span lang=EN-US>struct</span></span><span lang=EN-US> run(3115):</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>struct</span></span></span><span
lang=EN-US> run {</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>struct</span></span> run *next;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>};</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span lang=EN-US>struct</span></span><span
lang=EN-US> {<span style='mso-tab-count:6'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//spin
lock</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>struct</span></span> spinlock lock;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>int</span></span> <span class=SpellE>use_lock</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>struct</span></span> run *<span class=SpellE>freelist</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>} <span class=SpellE>kmem</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>它儲存每<span
class=GramE>個</span>釋放</span><span lang=EN-US>page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>的</span><span
lang=EN-US>run</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>結構在釋放</span><span lang=EN-US>page</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>本身，自從沒有其他儲存在那。<span class=GramE>空烈表示</span>被一個</span><span
lang=EN-US>spin lock</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>保護。這列表和這個</span><span lang=EN-US>lock</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>被包在一個</span><span
class=SpellE><span lang=EN-US>struct</span></span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>去弄清楚這個</span><span lang=EN-US>lock</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>保護在</span><span
class=SpellE><span lang=EN-US>struct</span></span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>的領域。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>Main</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>呼叫</span><span lang=EN-US>kinit1</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>和</span><span
lang=EN-US>kinit2</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>去初始化分配</span><span lang=EN-US>(3131):</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=GramE><span lang=EN-US>kinit1(</span></span><span
lang=EN-US>void *<span class=SpellE>vstart</span>, void *vend)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>{</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>initlock</span></span><span class=GramE>(</span>&amp;<span
class=SpellE>kmem.lock</span>, &quot;<span class=SpellE>kmem</span>&quot;);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>kmem.use_lock</span> = 0;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>freerange</span></span><span class=GramE>(</span><span
class=SpellE>vstart</span>, vend);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>void</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=GramE><span lang=EN-US>kinit2(</span></span><span
lang=EN-US>void *<span class=SpellE>vstart</span>, void *vend)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>{</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>freerange</span></span><span class=GramE>(</span><span
class=SpellE>vstart</span>, vend);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>kmem.use_lock</span> = 1;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>對於很多</span><span
lang=EN-US>main</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>一個不能使用</span><span lang=EN-US>locks</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>或記憶體在</span><span lang=EN-US>4MB</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>以上。</span><span
lang=EN-US>Kinit1</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>設定給</span><span lang=EN-US>lock-less</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>分配在前</span><span lang=EN-US>4GB</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>，</span><span
lang=EN-US>kinit2</span><span class=GramE><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>使鎖住</span></span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>和安排更多記憶體去配分配。</span><span lang=EN-US>Main</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>應該去確定多少實體記憶體是可用的，但這在</span><span
lang=EN-US>x86</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>上很困難。</span><span lang=EN-US>kinity1</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>和</span><span lang=EN-US>kinit2</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>呼叫</span><span
class=SpellE><span lang=EN-US>freerange</span></span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>去增加記憶體到空列表藉由每<span class=GramE>個</span></span><span
lang=EN-US>page</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>呼叫</span><span class=SpellE><span lang=EN-US>kfree</span></span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>。一個</span><span
lang=EN-US>PTE</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>可以只有指向一個實體記憶體，所以</span><span class=SpellE><span lang=EN-US>freerange</span></span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>使用</span><span
lang=EN-US>PGROUNDUP</span><span class=GramE><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>去卻表它</span></span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>釋放只有實體地址。分配開始沒有記憶體；這些呼叫去</span><span
class=SpellE><span lang=EN-US>kfree</span></span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>給它一些去管理。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>分配到實體</span><span
lang=EN-US>page</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>藉由它們的虛擬地址，不是藉由它們的實體地址，這是為什麼</span><span lang=EN-US>kinit</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>使用</span><span
lang=EN-US>P2V(PHYSTOP)</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>去翻譯</span><span lang=EN-US>PHYSTOP(</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>一個實體地址</span><span
lang=EN-US>)</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>到一個虛擬地址。分配有時候會用整數代表地址為了方便運算，有時候使用</span><span lang=EN-US>pointer</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>去讀和寫記憶體；地址的雙重使用的主要原因是分配程式碼都是</span><span
lang=EN-US>C type</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>。另一個原因是釋放和分配本質改變記憶體的型態。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>Kfree</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span lang=EN-US>3164):</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>kfree</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span lang=EN-US>char *v)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>{</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>struct</span></span> run *r;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>(<span class=SpellE>uint</span>)v % PGSIZE || v &lt; end
|| V2P(v) &gt;= PHYSTOP)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>panic(</span>&quot;<span class=SpellE>kfree</span>&quot;);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// Fill with junk
to catch dangling refs.</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>memset</span></span><span class=GramE>(</span>v,
1, PGSIZE);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>kmem.use_lock</span>)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>acquire(</span>&amp;<span class=SpellE>kmem.lock</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>r = (<span
class=SpellE>struct</span> run*<span class=GramE>)v</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>r</span>&#8722;&gt;next = <span class=SpellE>kmem.freelist</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>kmem.freelist</span> = r;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>kmem.use_lock</span>)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>release(</span>&amp;<span class=SpellE>kmem.lock</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>開始就由設定在記憶體的每<span
class=GramE>個</span></span><span lang=EN-US>byte</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>開始<span class=GramE>釋放到值</span></span><span
lang=EN-US>1</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>。這會造成程式碼使用記憶體在釋放它之後去讀垃圾取代舊的值；希望這會更快。</span><span class=SpellE><span
lang=EN-US>Kfree</span></span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>的</span><span lang=EN-US>v</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>是</span><span
lang=EN-US>pointer</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>到</span><span class=SpellE><span lang=EN-US>struct</span></span><span
lang=EN-US> run</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>，紀錄就的開始釋放列表在</span><span lang=EN-US>r-&gt;next</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>，設定釋放列表等於</span><span
lang=EN-US>r</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>。</span><span class=SpellE><span lang=EN-US>kalloc</span></span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>移除和回傳在釋放列表的第一個元素。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span lang=EN-US>User
part of an address space<o:p></o:p></span></b></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>每<span
class=GramE>個</span>使用者</span><span lang=EN-US>process</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>開始在地址</span><span
lang=EN-US>0</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>。地址空間的底部包含使用者程式碼、資料和堆疊。</span><span lang=EN-US>Heap</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>在堆疊之上所以</span><span
lang=EN-US>heap</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>可以擴展當它呼叫</span><span class=SpellE><span lang=EN-US>sbrk</span></span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>。當</span><span
lang=EN-US>xv6</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>擴展一個</span><span lang=EN-US>process</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>的</span><span lang=EN-US>heap</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>，它可以使用任何</span><span
lang=EN-US>free</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>的實體</span><span lang=EN-US>page</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>給新的虛擬</span><span lang=EN-US>page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>然後讓</span><span
lang=EN-US>page table</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>硬體去配對虛擬</span><span lang=EN-US>page</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>到分配的實體</span><span lang=EN-US>page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>堆疊是單一的</span><span
lang=EN-US>page</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>，表示和被</span><span lang=EN-US>exec</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>創造的初始內容一樣。</span><span lang=EN-US>Strings</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>包含命令參數，就像一個</span><span
lang=EN-US>pointer</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>的陣列到它們，是在堆疊的頂端。一個程式從</span><span lang=EN-US>main</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>開始就向</span><span
lang=EN-US>function</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>呼叫</span><span lang=EN-US>main(<span class=SpellE>argc,argv</span>)</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>開始。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span lang=EN-US>Code:
<span class=SpellE>sbrk</span><o:p></o:p></span></b></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span lang=EN-US>Sbrk</span></span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>是</span><span
lang=EN-US>system call</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>給一個</span><span lang=EN-US>process</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>去收縮或成長它的記憶體。藉由</span><span
class=SpellE><span lang=EN-US>growproc</span></span><span lang=EN-US>(2558)</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>來實施；</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>growproc</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span class=SpellE><span
lang=EN-US>int</span></span><span lang=EN-US> n)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>{</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>sz</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>struct</span></span> proc *<span class=SpellE>curproc</span>
= <span class=SpellE>myproc</span>();</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>sz</span> = <span class=SpellE>curproc</span>&#8722;&gt;<span
class=SpellE>sz</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>如果</span><span
lang=EN-US>n</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>是正的</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>n &gt; 0){</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//
<span class=SpellE>growproc</span></span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>分配一個以上的實體</span><span lang=EN-US>page</span></p>

<p class=MsoNormal style='margin-left:72.0pt;text-indent:24.0pt;line-height:
16.0pt;mso-line-height-rule:exactly'><span lang=EN-US>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>和對應它們在</span><span
lang=EN-US>process</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>的地址空間頂端</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>(<span class=SpellE>sz</span> = <span class=SpellE>allocuvm</span>(<span
class=SpellE>curproc</span>&#8722;&gt;<span class=SpellE>pgdir</span>, <span
class=SpellE>sz</span>, <span class=SpellE>sz</span> + n)) == 0)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>return</span> &#8722;1;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>如果</span><span
lang=EN-US>n</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>是負的</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>} else <span
class=GramE>if(</span>n &lt; 0){</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//
<span class=SpellE>gorwproc</span></span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>不會對應一個以上</span><span lang=EN-US>page</span></p>

<p class=MsoNormal style='margin-left:72.0pt;text-indent:24.0pt;line-height:
16.0pt;mso-line-height-rule:exactly'><span lang=EN-US>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>從</span><span
lang=EN-US>process</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>的地址空間和釋放相應的實體</span><span lang=EN-US>page</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>(<span class=SpellE>sz</span> = <span class=SpellE>deallocuvm</span>(<span
class=SpellE>curproc</span>&#8722;&gt;<span class=SpellE>pgdir</span>, <span
class=SpellE>sz</span>, <span class=SpellE>sz</span> + n)) == 0)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>return</span> &#8722;1;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>curproc</span></span>&#8722;&gt;<span class=SpellE>sz</span>
= <span class=SpellE>sz</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>switchuvm</span></span><span class=GramE>(</span><span
class=SpellE>curproc</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>return</span> 0;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>Xv6</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>修正</span><span lang=EN-US>process</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>的</span><span
lang=EN-US>page table</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>。</span><span lang=EN-US>Process</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>的</span><span lang=EN-US>page table</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>被儲存在記憶體，所以</span><span
lang=EN-US>kernel</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>可以用普通分配指令升級</span><span lang=EN-US>table</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>，</span><span
class=SpellE><span lang=EN-US>allocuvm</span></span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>和</span><span class=SpellE><span
lang=EN-US>deallocuvm</span></span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>去做。</span><span lang=EN-US>X86</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>硬體</span><span
lang=EN-US>caches page table</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>進入在</span><span lang=EN-US>Translation
Look-aside Buffer(TLB)</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>，當</span><span lang=EN-US>xv6</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>改變</span><span
lang=EN-US>page table</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>，它必須廢止</span><span lang=EN-US>cache</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>進入。如果它沒有廢止</span><span lang=EN-US>cache</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>進入，在某些時候</span><span
lang=EN-US>TLB</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>可能會使用到舊的配對，指向實體</span><span lang=EN-US>page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>時已經被分配到其他的</span><span
lang=EN-US>process</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>，結果會造成一個</span><span lang=EN-US>process</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>可能去用到其他</span><span
lang=EN-US>process</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>的記憶體。</span><span lang=EN-US>Xv6</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>廢止舊的</span><span lang=EN-US>cache</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>進入，就由重新讀入</span><span
lang=EN-US>cr3</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>暫存器保存了目前</span><span lang=EN-US>page table</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>的地址。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal><b style='mso-bidi-font-weight:normal'><span lang=EN-US>Code:
exec<o:p></o:p></span></b></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>Exec</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>是</span><span lang=EN-US>system call</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>創造一個地址空間的使用者部分。它初始化地址空間的使用者部分從一個檔案儲存到檔案系統。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=GramE><span lang=EN-US>Exec(</span></span><span
lang=EN-US>6610):</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=GramE><span lang=EN-US>exec(</span></span><span
lang=EN-US>char *path, char **<span class=SpellE>argv</span>)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>{</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>char</span> *s, *last;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>int</span></span> <span class=SpellE>i</span>,
off;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>argc</span>,
<span class=SpellE>sz</span>, <span class=SpellE>sp</span>, <span class=SpellE>ustack</span>[3+MAXARG+1];</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>struct</span></span> <span class=SpellE>elfhdr</span>
elf;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>struct</span></span> <span class=SpellE>inode</span>
*<span class=SpellE>ip</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>struct</span></span> <span class=SpellE>proghdr</span>
<span class=SpellE>ph</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>pde_t</span> *<span class=SpellE>pgdir</span>, *<span
class=SpellE>oldpgdir</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>struct</span></span> proc *<span class=SpellE>curproc</span>
= <span class=SpellE>myproc</span>();</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>begin_<span class=GramE>op</span></span><span class=GramE>(</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>if((<span
class=SpellE>ip</span> = <span class=SpellE>namei</span>(path)) == 0){<span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp; </span><span style='mso-tab-count:
1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>開啟命名的二進位</span><span
lang=EN-US>path</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>end_<span class=GramE>op</span></span><span class=GramE>(</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>cprintf</span></span><span class=GramE>(</span>&quot;exec:
fail\n&quot;);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>return</span> &#8722;1;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ilock</span></span><span class=GramE>(</span><span
class=SpellE>ip</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>pgdir</span></span> = 0;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// </span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>檢查</span><span
lang=EN-US>ELF</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>標頭檔</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>若有錯誤，跳到</span><span
lang=EN-US>bad</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>readi</span>(<span class=SpellE>ip</span>,
(char*)&amp;elf, 0, <span class=SpellE>sizeof</span>(elf)) != <span
class=SpellE>sizeof</span>(elf))</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>goto</span></span> bad;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>elf.magic</span> != ELF_MAGIC)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>goto</span></span> bad;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>分配沒有被配對到新的</span><span
lang=EN-US>page table</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>(<span class=SpellE>pgdir</span> = <span class=SpellE>setupkvm</span>())
== 0)<span style='mso-tab-count:1'>&nbsp; </span></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>goto</span></span> bad;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// </span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>從記憶體讀程式</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>sz</span></span> = 0;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>for(</span><span class=SpellE>i</span>=0, off=<span class=SpellE>elf.phoff</span>;
<span class=SpellE>i</span>&lt;<span class=SpellE>elf.phnum</span>; <span
class=SpellE>i</span>++, off+=<span class=SpellE>sizeof</span>(<span
class=SpellE>ph</span>)){</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>readi</span>(<span class=SpellE>ip</span>,
(char*)&amp;<span class=SpellE>ph</span>, off, <span class=SpellE>sizeof</span>(<span
class=SpellE>ph</span>)) != <span class=SpellE>sizeof</span>(<span
class=SpellE>ph</span>))</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>goto</span></span> bad;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>ph.type</span> != ELF_PROG_LOAD)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>continue</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>ph.memsz</span> &lt; <span
class=SpellE>ph.filesz</span>)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>goto</span></span> bad;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>ph.vaddr</span> + <span class=SpellE>ph.memsz</span>
&lt; <span class=SpellE>ph.vaddr</span>)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>goto</span></span> bad;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>分配記憶體給每<span
class=GramE>個</span></span><span lang=EN-US>ELF</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>區段</span></p>

<p class=MsoNormal style='margin-left:72.0pt;text-indent:24.0pt;line-height:
16.0pt;mso-line-height-rule:exactly'><span lang=EN-US>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>檢查虛擬地址要求在</span><span
lang=EN-US>KERNBASE</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>之下</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>(<span class=SpellE>sz</span> = <span class=SpellE>allocuvm</span>(<span
class=SpellE>pgdir</span>, <span class=SpellE>sz</span>, <span class=SpellE>ph.vaddr</span>
+ <span class=SpellE>ph.memsz</span>)) == 0)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>goto</span></span> bad;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>ph.vaddr</span> % PGSIZE != 0)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>goto</span></span> bad;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>loaduvm</span>(<span class=SpellE>pgdir</span>,
(char*)<span class=SpellE>ph.vaddr</span>, <span class=SpellE>ip</span>, <span
class=SpellE>ph.off</span>, <span class=SpellE>ph.filesz</span>) &lt; 0)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>goto</span></span> bad;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>iunlockput</span></span><span class=GramE>(</span><span
class=SpellE>ip</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>end_<span class=GramE>op</span></span><span class=GramE>(</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ip</span></span> = 0;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//
</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>分配兩個</span><span
lang=EN-US>page</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>在下一個</span><span lang=EN-US>page</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>的範圍</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//
Make the first inaccessible. </span></p>

<p class=MsoNormal style='margin-left:72.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>//Use the second as the user stack.</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>sz</span></span> = PGROUNDUP(<span class=SpellE>sz</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>讀每<span
class=GramE>個</span>區段進入記憶體</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>(<span class=SpellE>sz</span> = <span class=SpellE>allocuvm</span>(<span
class=SpellE>pgdir</span>, <span class=SpellE>sz</span>, <span class=SpellE>sz</span>
+ 2*PGSIZE)) == 0)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>goto</span></span> bad;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>clearpteu</span></span><span class=GramE>(</span><span
class=SpellE>pgdir</span>, (char*)(<span class=SpellE>sz</span> &#8722; 2*PGSIZE));</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>sp</span></span> = <span class=SpellE>sz</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//
Push argument <span class=GramE>strings,</span> prepare rest of stack in <span
class=SpellE>ustack</span>.</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>for(</span><span class=SpellE>argc</span> = 0; <span class=SpellE>argv</span>[<span
class=SpellE>argc</span>]; <span class=SpellE>argc</span>++) {</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>argc</span> &gt;= MAXARG)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>goto</span></span> bad;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>sp</span></span> = (<span class=SpellE>sp</span>
&#8722; (<span class=SpellE>strlen</span>(<span class=SpellE>argv</span>[<span
class=SpellE>argc</span>]) + 1)) &amp; ~3;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>copyout</span>(<span class=SpellE>pgdir</span>,
<span class=SpellE>sp</span>, <span class=SpellE>argv</span>[<span
class=SpellE>argc</span>], <span class=SpellE>strlen</span>(<span class=SpellE>argv</span>[<span
class=SpellE>argc</span>]) + 1) &lt; 0)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>goto</span></span> bad;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ustack</span></span><span class=GramE>[</span>3+argc]
= <span class=SpellE>sp</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ustack</span></span><span class=GramE>[</span>3+argc]
= 0;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ustack</span></span><span class=GramE>[</span>0]
= 0xffffffff; // fake return PC</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ustack</span></span><span class=GramE>[</span>1]
= <span class=SpellE>argc</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ustack</span></span><span class=GramE>[</span>2]
= <span class=SpellE>sp</span> &#8722; (argc+1)*4; // <span class=SpellE>argv</span>
pointer</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>sp</span> &#8722;= (3+argc+1) * 4;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>copyout</span>(<span class=SpellE>pgdir</span>,
<span class=SpellE>sp</span>, <span class=SpellE>ustack</span>, (3+argc+1)*4)
&lt; 0)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>goto</span></span> bad;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//
</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>為了</span><span
lang=EN-US>debug</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>儲存程式名</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>for(</span>last=s=path; *s; s++)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>*s == ’/’)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>last</span> = s+1;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>safestrcpy</span></span><span class=GramE>(</span><span
class=SpellE>curproc</span>&#8722;&gt;name, last, <span class=SpellE>sizeof</span>(<span
class=SpellE>curproc</span>&#8722;&gt;name));</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// Commit to the
user image.</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>oldpgdir</span></span> = <span class=SpellE>curproc</span>&#8722;&gt;<span
class=SpellE>pgdir</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>curproc</span></span>&#8722;&gt;<span class=SpellE>pgdir</span>
= <span class=SpellE>pgdir</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>curproc</span></span>&#8722;&gt;<span class=SpellE>sz</span>
= <span class=SpellE>sz</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>curproc</span></span>&#8722;&gt;<span class=SpellE>tf</span>&#8722;&gt;<span
class=SpellE>eip</span> = <span class=SpellE>elf.entry</span>; <span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>// main</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>curproc</span></span>&#8722;&gt;<span class=SpellE>tf</span>&#8722;&gt;<span
class=SpellE>esp</span> = <span class=SpellE>sp</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>switchuvm</span>(<span class=SpellE>curproc</span>);<span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//exec</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>安裝新的</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>freevm</span>(<span class=SpellE>oldpgdir</span>);<span
style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>釋放舊的</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>return 0;<span
style='mso-tab-count:5'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>回傳</span><span
lang=EN-US>0</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>bad:</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>pgdir</span>)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>freevm</span></span><span class=GramE>(</span><span
class=SpellE>pgdir</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>ip</span>){</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>iunlockput</span></span><span class=GramE>(</span><span
class=SpellE>ip</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>end_<span class=GramE>op</span></span><span class=GramE>(</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>return</span> &#8722;1;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>它讀</span><span
lang=EN-US>ELF header</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>。</span><span lang=EN-US>Xv6</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>硬硬被描述廣泛使用的</span><span lang=EN-US>ELF format</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>，定義在</span><span
class=SpellE><span lang=EN-US>elf.h</span></span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>。一個</span><span lang=EN-US>ELF</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>二進位包含一個</span><span
lang=EN-US>ELF header</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>、</span><span class=SpellE><span lang=EN-US>struct</span></span><span
lang=EN-US> <span class=SpellE>eldhdr</span>(0955):</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>struct</span></span></span><span
lang=EN-US> <span class=SpellE>elfhdr</span> {</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> magic; // must equal
ELF_MAGIC</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uchar</span></span> elf[12];</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> type;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> machine;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> version;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> entry;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>phoff</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>shoff</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> flags;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> <span class=SpellE>ehsize</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> <span class=SpellE>phentsize</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> <span class=SpellE>phnum</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> <span class=SpellE>shentsize</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> <span class=SpellE>shnum</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>ushort</span></span> <span class=SpellE>shstrndx</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>};</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span lang=EN-US>Struct</span></span><span
lang=EN-US> <span class=SpellE><span class=GramE>proghdr</span></span><span
class=GramE>(</span>0974):</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>struct</span></span></span><span
lang=EN-US> <span class=SpellE>proghdr</span> {</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> type;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> off;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>vaddr</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>paddr</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>filesz</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>memsz</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> flags;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> align;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>};</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>每<span
class=GramE>個</span></span><span class=SpellE><span lang=EN-US>proghdr</span></span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>描述一段應用必須被讀進記憶體；</span><span
lang=EN-US>xv6</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>程式碼只有一個程式區段標頭檔，但是其他系統可能分配區段給指令和資料。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>第一步是快速檢查檔案可能包含</span><span
lang=EN-US>ELF</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>二進位。一個</span><span lang=EN-US>ELF</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>二進位開始在</span><span lang=EN-US>4bytes</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>魔術數字</span> <span
lang=EN-US>‘0x7F’ , <span class=GramE>’</span>E<span class=GramE>’</span> , ‘L’
, <span class=GramE>’</span>F<span class=GramE>’</span> , <span class=GramE>’</span>ELF_MAGIC<span
class=GramE>’</span>(0952):</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>0952 #define ELF_MAGIC 0x464C457FU //
&quot;\x7FELF&quot; in little endian</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>如果</span><span
lang=EN-US>ELF</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>標頭檔已經有魔術數字，</span><span lang=EN-US>exec</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>假設二進位是正確格式。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>Loaduvm</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span lang=EN-US>1903):</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>loaduvm</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span class=SpellE><span
lang=EN-US>pde_t</span></span><span lang=EN-US> *<span class=SpellE>pgdir</span>,
char *<span class=SpellE>addr</span>, <span class=SpellE>struct</span> <span
class=SpellE>inode</span> *<span class=SpellE>ip</span>, <span class=SpellE>uint</span>
offset, <span class=SpellE>uint</span> <span class=SpellE>sz</span>)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>{</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> <span class=SpellE>i</span>,
pa, n;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>pte_t</span> *<span class=SpellE>pte</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>(<span class=SpellE>uint</span>) <span class=SpellE>addr</span>
% PGSIZE != 0)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>panic(</span>&quot;<span class=SpellE>loaduvm</span>: <span
class=SpellE>addr</span> must be page aligned&quot;);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>for(</span><span class=SpellE>i</span> = 0; <span class=SpellE>i</span>
&lt; <span class=SpellE>sz</span>; <span class=SpellE>i</span> += PGSIZE){</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>去尋找被分配的記憶體的實體地址，寫</span><span
lang=EN-US>ELF</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>片段的每<span class=GramE>個</span></span><span lang=EN-US>Page</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>(<span class=SpellE>pte</span> = <span class=SpellE>walkpgdir</span>(<span
class=SpellE>pgdir</span>, a <span class=SpellE>ddr+i</span>, 0)) == 0)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>panic(</span>&quot;<span class=SpellE>loaduvm</span>: address
should exist&quot;);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>pa</span> = PTE_ADDR(*<span class=SpellE>pte</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>sz</span> &#8722; <span class=SpellE>i</span>
&lt; PGSIZE)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>n
= <span class=SpellE>sz</span> &#8722; <span class=SpellE>i</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>else</span></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>n
= PGSIZE;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>//<span
class=SpellE>readi</span></span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>從檔案去讀</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span><span class=SpellE>readi</span>(<span class=SpellE>ip</span>,
P2V(pa), <span class=SpellE>offset+i</span>, n) != n)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>return</span> &#8722;1;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>return</span> 0;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>Exec</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>分配和初始化使用者堆疊。它分配只有一個堆疊</span><span lang=EN-US>page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>。</span><span
lang=EN-US>Exec</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>一次複製<span class=GramE>一</span>字串參數到堆疊的頂端，在</span><span
class=SpellE><span lang=EN-US>ustack</span></span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>紀錄指標。它放一個空指標在</span><span
class=SpellE><span lang=EN-US>argv</span></span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>列表傳向</span><span lang=EN-US>main</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>的尾端。前三<span
class=GramE>個</span>進入</span><span class=SpellE><span lang=EN-US>ustack</span></span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>是假的回傳</span><span
class=SpellE><span lang=EN-US>PC,argc,argv</span></span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>指標。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>Exec</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>放置一個遙遠的</span><span lang=EN-US>page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>在堆疊</span><span
lang=EN-US>page</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>底下，讓<span class=GramE>程式程式</span>去使用一個以上的</span><span lang=EN-US>page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>會失敗。這個遙遠的</span><span
lang=EN-US>page</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>也允許</span><span lang=EN-US>exec</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>去處理太大的參數；</span><span class=SpellE><span
class=GramE><span lang=EN-US>copyout</span></span></span><span class=GramE><span
lang=EN-US>(</span></span><span lang=EN-US>2118):</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span class=SpellE><span class=GramE><span lang=EN-US>copyout</span></span></span><span
class=GramE><span lang=EN-US>(</span></span><span class=SpellE><span
lang=EN-US>pde_t</span></span><span lang=EN-US> *<span class=SpellE>pgdir</span>,
<span class=SpellE>uint</span> <span class=SpellE>va</span>, void *p, <span
class=SpellE>uint</span> <span class=SpellE>len</span>)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>{</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>char</span> *<span class=SpellE>buf</span>, *pa0;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>uint</span></span> n, va0;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><o:p>&nbsp;</o:p></span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE>buf</span> = (char*<span class=GramE>)p</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>while(</span><span class=SpellE>len</span> &gt; 0){</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>va0
= (<span class=SpellE>uint</span><span class=GramE>)PGROUNDDOWN</span>(<span
class=SpellE>va</span>);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>pa0
= <span class=GramE>uva2ka(</span><span class=SpellE>pgdir</span>, (char*)va0);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>pa0 == 0)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>return</span> &#8722;1;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>n
= PGSIZE &#8722; (<span class=SpellE><span class=GramE>va</span></span> &#8722; va0);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>if(</span>n &gt; <span class=SpellE>len</span>)</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:3'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>n
= <span class=SpellE>len</span>;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>memmove</span></span><span class=GramE>(</span>pa0
+ (<span class=SpellE>va</span> &#8722; va0), <span class=SpellE>buf</span>, n);</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>len</span></span> &#8722;= n;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>buf</span></span> += n;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:2'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=SpellE><span class=GramE>va</span></span> = va0 + PGSIZE;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US><span style='mso-spacerun:yes'>&nbsp;</span><span
style='mso-tab-count:1'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span><span
class=GramE>return</span> 0;</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>}</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span lang=EN-US>Exec</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>使用它去複製參數到堆疊會注意目的地</span><span lang=EN-US>page</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>不可訪問，和回傳</span><span
lang=EN-US>-1</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>。</span></p>

<p class=MsoNormal style='text-indent:24.0pt;line-height:16.0pt;mso-line-height-rule:
exactly'><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>在準備新的記憶體<span
class=GramE>期間，</span>如果</span><span lang=EN-US>exec</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>檢查到一個錯誤像無效程式碼片段，它跳到</span><span
lang=EN-US>bad</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>，釋放新的，回傳</span><span lang=EN-US>-1</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>。</span><span lang=EN-US>Exec</span><span
style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:
minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;
mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>會等待釋放舊的直到它確定</span><span
lang=EN-US>system call</span><span style='font-family:"新細明體","serif";
mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:
新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;
mso-hansi-theme-font:minor-latin'>會成功：如果舊的離開了，</span><span lang=EN-US>system
call</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:Calibri;
mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;mso-fareast-theme-font:
minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:minor-latin'>不能回傳</span><span
lang=EN-US>-1</span><span style='font-family:"新細明體","serif";mso-ascii-font-family:
Calibri;mso-ascii-theme-font:minor-latin;mso-fareast-font-family:新細明體;
mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:Calibri;mso-hansi-theme-font:
minor-latin'>。唯一的錯誤在</span><span lang=EN-US>exec</span><span style='font-family:
"新細明體","serif";mso-ascii-font-family:Calibri;mso-ascii-theme-font:minor-latin;
mso-fareast-font-family:新細明體;mso-fareast-theme-font:minor-fareast;mso-hansi-font-family:
Calibri;mso-hansi-theme-font:minor-latin'>發生在創造的期間。</span></p>

<p class=MsoNormal style='line-height:16.0pt;mso-line-height-rule:exactly'><span
lang=EN-US><o:p>&nbsp;</o:p></span></p>

</div>

</body>

</html>
